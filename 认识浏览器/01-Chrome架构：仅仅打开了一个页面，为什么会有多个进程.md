

##  一、Chrome架构：仅仅打开了一个页面，为什么有4个进程？

>  点击Chrome浏览器右上角的“选项”菜单，选择“任务管理器”，这将打开Chrome的任务管理器的窗口，一个页面会启动多个进程
![1](https://user-images.githubusercontent.com/72426886/132111943-acc312e6-7b15-4a40-8caa-7b8806c2f0fe.png)

### 进程和线程

> 在介绍进程和线程之前，我们需要了解什么是并行处理，了解之后，再理解进程和线程之间的关系就会变得轻松许多。

### 什么是并行处理

```js
A = 1+2
B = 20/5
C = 7+8
```

正常情况下程序可以使用**单线程**来处理，也就是分四步按照顺序分别执行这四个任务。

如果采用**多线程**，我们只需要分“两步走”：第一步，使用三个线程同时执行前三个任务，第二步，再执行第四个显示任务。因此使用**并行处理能大大提升性能。**

### 线程 VS 进程

> 线程是不能单独存在的，它是由进程来启动和管理的。

**一个进程就是一个程序的运行实例。**

启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放代码、运行中的数据和一个执行任务的主线程，我们把这样的一个运行环境叫**进程**。

**线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率。**
![1630805233730](https://user-images.githubusercontent.com/72426886/132111969-a9bb8e7f-fb34-4e5d-adc2-eba0f3e57957.png)

> 总结来说，进程和线程之间有以下4个特点：

1. 进程中的任意一线程执行出错，都会导致整个进程的崩溃。
   > 在计算B的值的时候，我们把表达式的分母改为0，线程会执行出错，会导致进程的崩溃。
2. 线程之间共享进程中的数据。
   4. 当一个进程关闭之后，操作系统会回收进程所占用的内存
   > 当一个进程退出时，操作系统会回收该进程所申请的所有资源；即使其中任意线程因为操作不当导致内存泄漏，当进程退出时，这些内存也会被正确回收。
5. 进程之间的内容相互隔离。
   > 一个进程如果崩溃了，或者挂起了，是不会影响到其他进程的。如果进程之间需要进行数据的通信，这时候，就需要使用用于进程间通信的IPC机制。

### 单进程浏览器时代
> 单进程浏览器是指浏览器的所有功能模块都是运行在同一个进程里，这些模块包含了网络、插件、JavaScript运行环境、渲染引擎和页面等。
![1630805246464](https://user-images.githubusercontent.com/72426886/132112054-b3747706-d4c8-41e9-be12-aec2fedb382e.png)


因此会导致**不稳定**、**不流畅**、**不安全**的问题
1. 不稳定
> 一个插件的意外崩溃会引起整个浏览器的崩溃。
2. 不流畅
> 同一时刻只能有一个模块可以执行。
3. 不安全
> 插件可以获得系统资源和权限。

#### 内存泄漏
这也是单进程变慢的一个重要原因，通常浏览器的内核都是非常复杂的，运行一个复杂点的页面再关闭页面，会存在内存不能完全回收的情况，这样导致的问题是使用时间越长，内存占用越高，浏览器会变得越慢。
### 多进程浏览器时代
#### 早期多进程架构

![1630805252858](https://user-images.githubusercontent.com/72426886/132112058-93d3c68e-bc99-498f-b702-8cb17bd35c22.png)

从图中可以看出，Chrome的页面是运行在单独的渲染进程中，同时页面里的插件也是运行在单独的插件进程之中，而进程之间是通过IPC机制进行通信。

1. 如何解决不稳定的问题
   > 由于进程是相互隔离的，所以当一个页面或者插件崩溃时，影响到的仅仅是当前的页面进程或者插件进程。
2. 如何解决不流畅的问题
   > JavaScript也是运行在渲染进程中，所以即使JavaScript阻塞了渲染进程，影响到的也只是当前的渲染页面，而不会影响浏览器和其他页面，**因为其他页面的脚本是运行在它们自己的渲染进程中的**。
3. 如何解决安全问题
   > 采用多进程架构的好处是可以使用**安全沙箱**，可以把沙箱看成是操作系统给进程上了一把锁，沙箱里面的程序可以运行，但是不能在你的硬盘中写入任何数据，也不能从敏感位置读取任何数据。
#### 目前多进程架构
参考下图：
![1630805265992](https://user-images.githubusercontent.com/72426886/132111986-dbb59ec4-d9ac-443f-914e-7820ae7f6efc.png)

> 最新的Chrome浏览器包括:1个浏览器主进程、1个GPU进程、1个网络进程、多个渲染进程、多个插件进程。
- 浏览器进程
  主要负责界面显示、用户交互、子进程管理、同时提供存储功能。
- 渲染进程
  核心任务是将HTML、CSS和JavaScript转换为用户可以与之交互的网页，排版引擎Blink和JavaScriptV8引擎都是运行在该进程中，默认情况下，Chrome会为每个Tab标签创建一个渲染进程，处于安全考虑，运行在沙箱模式下。
- GPU进程
  Chrome刚开始发布的时候是没有GPU进程的。而GPU的使用初衷是为了实现3D CSS效果，只是后来随着网页、Chrome的UI界面都选择采用GPU来绘制，这使得GPU称为浏览器普遍的需求，最后在Chrome的多进程架构中引入了GPU进程。
- 网络进程
  主要负责页面网络资源的加载
- 插件进程
  主要负责插件的运行，因为插件容易崩溃，所以需要插件进程来隔离，保证插件进程崩溃不会对浏览器和页面造成影响。
#### 多进程架构也会带来一些问题
- 更高的资源占用
  每个进程都会包含公共的基础结构副本（如JavaScript运行环境），这就意味着浏览器会消耗更多的内存资源。
- 更复杂的体系结构，浏览器各模块之间耦合性高、扩展性差等问题。
### 未来面向服务的架构（SOA）
![1630805273068](https://user-images.githubusercontent.com/72426886/132111992-9c60409a-16a3-437c-a113-c0955135693e.png)

> 和现代操作系统一样，原来的各种模块会被重构成独立的服务，每个服务都可以在独立的进程中运行，访问服务必须使用定义好的接口，通过IPC来通信，从而**构建一个更内聚、松耦合、易于维护和扩展的系统。**，更好的实现Chrome简单、稳定、高速、安全的目标。

> 目前Chrome正处在老的架构向服务化架构过渡阶段这将是一个漫长的迭代过程。

> 同时Chrome还提供灵活的弹性架构，在强大性能设备上会以多进程的形式运行基础服务，在资源受限的设备上，会将更多的服务整合到一个进程中。
